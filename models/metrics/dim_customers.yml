semantic_models:
  - name: customers
    defaults:
      agg_time_dimension: first_ordered_at
    description: |
      Customer grain mart.
    model: ref('dim_customers')
    entities:
      - name: customer
        expr: customer_id
        type: primary
    dimensions:
      - name: customer_name
        type: categorical
      - name: customer_type
        type: categorical
      - name: first_ordered_at
        type: time
        type_params:
          time_granularity: day
      - name: last_ordered_at
        type: time
        type_params:
          time_granularity: day
    measures:
      - name: count_lifetime_orders
        description: Total count of orders per customer.
        agg: sum
      - name: lifetime_spend_pretax
        description: Customer lifetime spend before taxes.
        agg: sum
      - name: lifetime_spend_pretax_avg
        description: average Customer lifetime spend before taxes.
        agg: average
        expr: lifetime_spend_pretax
      - name: lifetime_spend
        agg: sum
        description: Gross customer lifetime spend inclusive of taxes.
      - name: customers
        expr: customer_id
        agg: count_distinct
      - name: customers_with_spends
        expr: lifetime_spend_pretax
        agg: count

metrics:
  - name: "customers"
    description: "Count of customers"
    type: simple
    label: "customers"
    type_params:
      measure: customers
  
  - name: "customers_with_spends"
    description: "Count of customers with spends"
    type: simple
    label: "customers_with_spends"
    type_params:
      measure: customers_with_spends

  - name: "customers_lifetime_spend"
    label: "customers_lifetime_spend"
    type: simple
    type_params:
      measure: count_lifetime_orders
  
  - name: "customers_lifetime_spend_amount"
    label: "customers_lifetime_spend_amount"
    type: simple
    type_params:
      measure: lifetime_spend_pretax

  - name: "customers_lifetime_spend_avg"
    label: "customers_lifetime_spend_avg"
    type: simple
    type_params:
      measure: lifetime_spend_pretax_avg

  - name: customer_spend_pct
    label: customer spend ratio
    type: ratio
    type_params: 
      numerator: 
        name: customers_lifetime_spend_amount
      denominator: 
        name: customers_with_spends

  - name: customer_spend_pct_derived
    label: customer spend ratio derived
    type: derived
    type_params:
      expr: customers_lifetime_spend_amount / customers_with_spends
      metrics:
        - name: customers_lifetime_spend_amount
        - name: customers_with_spends    

  - name: cumulative_customers_ratio
    label: Cumulative customers ratio
    description: cumulative customers ratio
    type: cumulative
    type_params:
      measure: 
        name: customers
      window: 1 month #grain_to_date: day
